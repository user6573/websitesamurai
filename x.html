<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Shitstorm-Simulation ¬∑ X / Twitter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: dark;
    }

    body {
      margin: 0;
      background:
        radial-gradient(circle at 0% 0%, #0f172a 0, #020617 40%, #000 75%),
        radial-gradient(circle at 100% 100%, #020617 0, #000 55%);
      color: #e7e9ea;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app {
      display: flex;
      justify-content: center;
      width: 100%;
      max-width: 1100px;
      padding: 1.25rem 0.75rem;
      box-sizing: border-box;
    }

    .timeline {
      width: min(700px, 100%);
      border-radius: 1.25rem;
      overflow: hidden;
      border: 1px solid #1f2933;
      min-height: calc(100vh - 2.5rem);
      display: flex;
      flex-direction: column;
      background: rgba(0, 0, 0, 0.96);
      box-shadow:
        0 18px 60px rgba(0, 0, 0, 0.6),
        0 0 0 1px rgba(15, 23, 42, 0.8);
    }

    /* Header: X-Symbol + X-Simulation + Status rechts */
    .timeline-header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(0, 0, 0, 0.92);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid #2f3336;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .x-logo {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid #2f3336;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
      letter-spacing: 0.02em;
      background: radial-gradient(circle at 30% 0%, #0b1120, #020617);
    }

    .header-title {
      font-size: 1.05rem;
      font-weight: 700;
    }

    .header-sub {
      font-size: 0.78rem;
      color: #71767b;
      margin-top: 0.08rem;
    }

    .header-text {
      display: flex;
      flex-direction: column;
    }

    .status-pill {
      margin-left: auto;
      font-size: 0.75rem;
      color: #71767b;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      border: 1px solid #2f3336;
      background: rgba(15, 23, 42, 0.7);
    }

    .status-pill span {
      color: #e7e9ea;
      font-weight: 500;
    }

    .status-bar {
      font-size: 0.75rem;
      color: #71767b;
      padding: 0.3rem 1rem 0.45rem;
      border-bottom: 1px solid #2f3336;
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .status-bar span {
      font-weight: 500;
      color: #e7e9ea;
    }

    .status-bar-label {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.18);
    }

    .thread {
      border-bottom: 1px solid #2f3336;
    }

    .main-tweet-container {
      padding: 0.9rem 1rem 0.35rem;
      border-bottom: 1px solid #2f3336;
      background: radial-gradient(circle at 0% 0%, #020617, #020617 60%, #000 100%);
    }

    .tweet.main {
      padding: 0;
      border-bottom: none;
    }

    .tweet {
      display: flex;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #16181c;
      gap: 0.6rem;
      transition: background-color 0.12s ease, border-color 0.12s ease;
    }

    .tweet.reply:hover {
      background: rgba(15, 23, 42, 0.65);
    }

    .avatar {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #2f3336;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.83rem;
      color: #cfd3d7;
      flex-shrink: 0;
      background-size: cover;
      background-position: center;
      overflow: hidden;
      text-transform: uppercase;
    }

    .avatar.company {
      border-color: #1d9bf0;
      color: #1d9bf0;
      box-shadow: 0 0 0 1px rgba(29, 155, 240, 0.3);
    }

    .avatar.community {
      border-color: #f91880;
      color: #f91880;
    }

    .avatar.coach {
      border-color: #facc15;
      color: #facc15;
    }

    .tweet-body {
      flex: 1;
      min-width: 0;
    }

    .tweet-header {
      display: flex;
      align-items: baseline;
      gap: 0.35rem;
      font-size: 0.84rem;
    }

    .tweet-name {
      font-weight: 600;
    }

    .tweet-handle {
      color: #71767b;
      font-size: 0.78rem;
    }

    .tweet-meta {
      color: #71767b;
      font-size: 0.75rem;
      margin-left: auto;
    }

    .tweet-text {
      margin-top: 0.3rem;
      font-size: 1.03rem;
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.45;
    }

    .tweet-text.small {
      font-size: 0.9rem;
      color: #9ca3af;
    }

    .scenario-text {
      font-size: 0.8rem;
      color: #a1a1aa;
      margin-top: 0.4rem;
      white-space: pre-wrap;
    }

    .tweet-actions {
      display: flex;
      gap: 1.4rem;
      margin-top: 0.6rem;
      font-size: 0.8rem;
      color: #71767b;
    }

    .tweet-actions span {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      cursor: default;
    }

    .tweet-actions span::before {
      font-family: system-ui, sans-serif;
      opacity: 0.75;
      font-size: 0.9rem;
    }

    .tweet-actions span[data-type="reply"]::before {
      content: "üí¨";
    }
    .tweet-actions span[data-type="retweet"]::before {
      content: "üîÅ";
    }
    .tweet-actions span[data-type="like"]::before {
      content: "‚ù§";
    }

    .replies-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.35rem 0 0.45rem;
      font-size: 0.78rem;
      color: #71767b;
      gap: 0.5rem;
    }

    #scenarioShort {
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 65%;
    }

    .btn-toggle {
      border-radius: 999px;
      border: 1px solid #2f3336;
      background: #020617;
      color: #e7e9ea;
      font-size: 0.75rem;
      padding: 0.25rem 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      transition: background-color 0.12s ease, border-color 0.12s ease, transform 0.05s ease;
    }

    .btn-toggle span.chevron {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .btn-toggle:disabled {
      opacity: 0.45;
      cursor: default;
    }

    .btn-toggle:hover:not(:disabled) {
      background: #0b1120;
      border-color: #374151;
      transform: translateY(-0.5px);
    }

    .replies-section.hidden {
      display: none;
    }

    .replies-label {
      padding: 0.45rem 1rem 0.2rem;
      font-size: 0.78rem;
      color: #71767b;
      border-top: 1px solid #16181c;
      border-bottom: 1px solid #16181c;
      background: #020617;
    }

    .tweet.reply {
      position: relative;
      padding-left: 1.2rem;
    }

    .tweet.reply::before {
      content: "";
      position: absolute;
      left: 32px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: rgba(51, 65, 85, 0.85);
    }

    .tweet.reply:first-child::before {
      top: 20px;
    }

    .tweet.reply:last-child::before {
      bottom: 24px;
    }

    .composer {
      border-top: 1px solid #2f3336;
      padding: 0.6rem 1rem 0.85rem;
      display: flex;
      gap: 0.6rem;
      align-items: flex-start;
      background: rgba(0, 0, 0, 0.98);
    }

    .composer.disabled {
      opacity: 0.6;
    }

    .composer textarea {
      flex: 1;
      border-radius: 0.9rem;
      border: 1px solid #2f3336;
      background: #020617;
      color: #e7e9ea;
      font: inherit;
      font-size: 0.9rem;
      padding: 0.5rem 0.7rem;
      min-height: 60px;
      resize: vertical;
      outline: none;
      transition: border-color 0.12s ease, box-shadow 0.12s ease, background-color 0.12s ease;
    }

    .composer textarea::placeholder {
      color: #6b7280;
    }

    .composer textarea:focus {
      border-color: #1d9bf0;
      box-shadow: 0 0 0 1px rgba(29, 155, 240, 0.45);
      background-color: #020617;
    }

    .composer-footer {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      align-items: flex-end;
    }

    .composer-hint {
      font-size: 0.72rem;
      color: #71767b;
      max-width: 260px;
      text-align: right;
    }

    .btn-primary {
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #1d9bf0, #38bdf8);
      color: #fff;
      font-weight: 600;
      padding: 0.42rem 1.1rem;
      font-size: 0.85rem;
      cursor: pointer;
      white-space: nowrap;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.7);
      transition: transform 0.08s ease, box-shadow 0.12s ease, filter 0.06s ease;
    }

    .btn-primary:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
    }

    .btn-primary:hover:not(:disabled) {
      filter: brightness(1.05);
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(15, 118, 178, 0.55);
    }

    .debug-card {
      border-top: 1px solid #2f3336;
      padding: 0.5rem 1rem 0.6rem;
      font-size: 0.72rem;
      color: #71767b;
      max-height: 160px;
      overflow: hidden;
      background: #020617;
    }

    .debug-card details {
      cursor: pointer;
    }

    .debug-card details[open] {
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      padding: 0.2rem 0.45rem 0.35rem;
      background: #020617;
    }

    .debug-card summary {
      list-style: none;
    }

    .debug-card summary::-webkit-details-marker {
      display: none;
    }

    .debug-card summary::before {
      content: "‚ñ∏ ";
      font-size: 0.7rem;
      opacity: 0.7;
    }

    .debug-card details[open] summary::before {
      content: "‚ñæ ";
    }

    .debug-card pre {
      margin: 0.25rem 0 0;
      max-height: 120px;
      overflow-y: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.7rem;
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="timeline">
      <div class="timeline-header">
        <div class="x-logo">X</div>
        <div class="header-text">
          <div class="header-title">X-Simulation</div>
          <div class="header-sub">Trainiere deine Krisenkommunikation</div>
        </div>
        <div class="status-pill">
          Status: <span id="statusPill">bereit</span>
        </div>
      </div>

      <div class="status-bar">
        <div class="status-bar-label">
          <span class="status-dot"></span>
          Runde: <span id="roundText">‚Äì</span>
        </div>
        <div>Intensit√§t: <span id="intensityText">‚Äì</span></div>
      </div>

      <div class="thread">
        <div class="main-tweet-container">
          <div id="mainTweet"></div>
          <div class="replies-header-row">
            <div id="scenarioShort"></div>
            <button id="toggleRepliesBtn" class="btn-toggle" disabled>
              <span class="chevron">‚ñæ</span>
              Kommentare anzeigen (0)
            </button>
          </div>
        </div>

        <div id="repliesSection" class="replies-section hidden">
          <div class="replies-label">Antworten der Community</div>
          <div id="replies"></div>
        </div>
      </div>

      <div class="composer disabled" id="composer">
        <div class="avatar company" id="composerAvatar">@</div>
        <div class="tweet-body">
          <textarea id="answerInput" placeholder="Ver√∂ffentliche dein offizielles Statement ‚Ä¶" disabled></textarea>
        </div>
        <div class="composer-footer">
          <div class="composer-hint">
            Deine Antwort erscheint oben als offizieller Post des Unternehmens. Die Community reagiert in den Kommentaren.
          </div>
          <button class="btn-primary" id="sendBtn" disabled>Posten</button>
        </div>
      </div>

      <div class="debug-card">
        <details>
          <summary>Debug-Antwort vom Server anzeigen</summary>
          <pre id="debugOutput"></pre>
        </details>
      </div>
    </div>
  </div>

  <script>
    // ===================== KONFIGURATION ===========================
    const BASE_URL = "https://DEIN-LANGGRAPH-SERVER";  // z.B. "https://xyz.eu.langgraph.app"
    const ASSISTANT_ID = "shitstorm";                  // Name aus langgraph.json
    const API_KEY = "";                                // LangSmith Key oder leer

    // Optionale Avatare f√ºr Community-User ‚Äì hier kannst du deine Bilder eintragen.
    const COMMUNITY_USERS = [
      { name: "Lena", handle: "@lenaleise", avatar: "avatars/user-lena.png" },
      { name: "Tom", handle: "@tom_talks", avatar: "avatars/user-tom.png" },
      { name: "Ali", handle: "@ali_opinion", avatar: "avatars/user-ali.png" },
      { name: "Mia", handle: "@mia_media", avatar: "avatars/user-mia.png" },
      { name: "Jonas", handle: "@jonas_crit", avatar: "avatars/user-jonas.png" },
      { name: "Sara", handle: "@saracomment", avatar: "avatars/user-sara.png" }
    ];

    let communityUserIndex = 0;

    // ===================== STATE & DOM =============================
    let threadId = null;
    let waitingForAnswer = false;
    let finished = false;
    let commentsVisible = false;
    let replyCount = 0;
    let startedOnce = false;

    const mainTweetEl = document.getElementById("mainTweet");
    const repliesEl = document.getElementById("replies");
    const repliesSectionEl = document.getElementById("repliesSection");
    const toggleRepliesBtn = document.getElementById("toggleRepliesBtn");
    const composerEl = document.getElementById("composer");
    const composerAvatarEl = document.getElementById("composerAvatar");
    const answerInputEl = document.getElementById("answerInput");
    const sendBtn = document.getElementById("sendBtn");
    const statusPillEl = document.getElementById("statusPill");
    const roundTextEl = document.getElementById("roundText");
    const intensityTextEl = document.getElementById("intensityText");
    const debugOutputEl = document.getElementById("debugOutput");
    const scenarioShortEl = document.getElementById("scenarioShort");

    let companyNameGlobal = "Dein Unternehmen";
    let causeGlobal = "nicht n√§her beschriebene Ursache";

    function buildHeaders() {
      const h = { "Content-Type": "application/json" };
      if (API_KEY && API_KEY.trim() !== "") {
        h["x-api-key"] = API_KEY.trim();
      }
      return h;
    }

    function setStatus(text) {
      statusPillEl.textContent = text;
    }

    function setComposerEnabled(on) {
      if (on) {
        composerEl.classList.remove("disabled");
        answerInputEl.disabled = false;
        sendBtn.disabled = false;
      } else {
        composerEl.classList.add("disabled");
        answerInputEl.disabled = true;
        sendBtn.disabled = true;
      }
    }

    function slugifyHandle(name) {
      return (
        name
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "")
          .slice(0, 12) || "brand"
      );
    }

    function resetThread() {
      repliesEl.innerHTML = "";
      mainTweetEl.innerHTML = "";
      debugOutputEl.textContent = "";
      roundTextEl.textContent = "‚Äì";
      intensityTextEl.textContent = "‚Äì";
      threadId = null;
      waitingForAnswer = false;
      finished = false;
      commentsVisible = false;
      replyCount = 0;
      startedOnce = false;
      setComposerEnabled(false);

      toggleRepliesBtn.disabled = true;
      toggleRepliesBtn.querySelector(".chevron").textContent = "‚ñæ";
      toggleRepliesBtn.textContent = "";
      toggleRepliesBtn.appendChild(document.createElement("span")).className = "chevron";
      toggleRepliesBtn.firstChild.textContent = "‚ñæ";
      toggleRepliesBtn.appendChild(document.createTextNode(" Kommentare anzeigen (0)"));

      repliesSectionEl.classList.add("hidden");

      scenarioShortEl.textContent = `Thema: ${causeGlobal}`;
      renderMainTweet(companyNameGlobal, "", { cause: causeGlobal, round: 0, intensity: 70 });
      updateComposerAvatar(companyNameGlobal);
    }

    function updateComposerAvatar(companyName) {
      const initial = (companyName.trim()[0] || "U").toUpperCase();
      composerAvatarEl.textContent = initial;
      composerAvatarEl.style.backgroundImage = "";
    }

    function renderMainTweet(companyName, text, opts = {}) {
      const handle = slugifyHandle(companyName);
      const round = opts.round ?? null;
      const intensity = typeof opts.intensity === "number" ? opts.intensity : null;
      const cause = opts.cause || causeGlobal;

      mainTweetEl.innerHTML = "";

      const tweet = document.createElement("div");
      tweet.classList.add("tweet", "main");

      const avatar = document.createElement("div");
      avatar.classList.add("avatar", "company");
      avatar.textContent = (companyName.trim()[0] || "U").toUpperCase();

      const body = document.createElement("div");
      body.classList.add("tweet-body");

      const header = document.createElement("div");
      header.classList.add("tweet-header");

      const name = document.createElement("span");
      name.classList.add("tweet-name");
      name.textContent = companyName;

      const handleEl = document.createElement("span");
      handleEl.classList.add("tweet-handle");
      handleEl.textContent = " @" + handle;

      const meta = document.createElement("span");
      meta.classList.add("tweet-meta");
      const pieces = [];
      if (round !== null && round !== undefined && round > 0) {
        pieces.push("Runde " + round);
      }
      if (intensity !== null && intensity !== undefined) {
        pieces.push("Intensit√§t " + intensity.toFixed(1) + "/100");
      }
      meta.textContent = pieces.join(" ¬∑ ");

      header.appendChild(name);
      header.appendChild(handleEl);
      if (meta.textContent) header.appendChild(meta);

      const textEl = document.createElement("div");
      textEl.classList.add("tweet-text");
      if (text && text.trim()) {
        textEl.textContent = text;
      } else {
        textEl.classList.add("small");
        textEl.textContent =
          "Noch kein offizielles Statement ver√∂ffentlicht. Formuliere unten deinen ersten Post als Unternehmen.";
      }

      body.appendChild(header);
      body.appendChild(textEl);

      if (cause) {
        const scenario = document.createElement("div");
        scenario.classList.add("scenario-text");
        scenario.textContent = `Shitstorm-Thema: ${cause}`;
        body.appendChild(scenario);
      }

      const actions = document.createElement("div");
      actions.classList.add("tweet-actions");
      const replies = document.createElement("span");
      replies.dataset.type = "reply";
      replies.textContent = "Kommentare";
      const retweets = document.createElement("span");
      retweets.dataset.type = "retweet";
      retweets.textContent = "Retweets";
      const likes = document.createElement("span");
      likes.dataset.type = "like";
      likes.textContent = "Likes";
      actions.appendChild(replies);
      actions.appendChild(retweets);
      actions.appendChild(likes);
      body.appendChild(actions);

      tweet.appendChild(avatar);
      tweet.appendChild(body);
      mainTweetEl.appendChild(tweet);
    }

    function pickCommunityUser() {
      if (COMMUNITY_USERS.length === 0) {
        return {
          name: "User",
          handle: "@user",
          avatar: ""
        };
      }
      const user = COMMUNITY_USERS[communityUserIndex % COMMUNITY_USERS.length];
      communityUserIndex++;
      return user;
    }

    function appendReply(role, text, opts = {}) {
      const tweet = document.createElement("div");
      tweet.className = "tweet reply";

      const avatar = document.createElement("div");
      avatar.classList.add("avatar");

      const body = document.createElement("div");
      body.classList.add("tweet-body");

      const header = document.createElement("div");
      header.classList.add("tweet-header");

      const name = document.createElement("span");
      name.classList.add("tweet-name");

      const handle = document.createElement("span");
      handle.classList.add("tweet-handle");

      const meta = document.createElement("span");
      meta.classList.add("tweet-meta");

      const textEl = document.createElement("div");
      textEl.classList.add("tweet-text", "small");
      textEl.textContent = text;

      const round = opts.round ?? "";
      const intensityVal =
        typeof opts.intensity === "number"
          ? opts.intensity.toFixed(1) + "/100"
          : "";

      if (role === "community") {
        const user = pickCommunityUser();
        avatar.classList.add("community");
        avatar.textContent = (user.name[0] || "U").toUpperCase();
        if (user.avatar) {
          avatar.style.backgroundImage = `url('${user.avatar}')`;
        }
        name.textContent = user.name;
        handle.textContent = " " + (user.handle || "@user");
      } else if (role === "coach") {
        avatar.classList.add("coach");
        avatar.textContent = "‚òÖ";
        name.textContent = "Crisis Coach";
        handle.textContent = " @coach";
      } else {
        name.textContent = "System";
        handle.textContent = " @sim";
      }

      if (round || intensityVal) {
        meta.textContent = `Runde ${round || "?"} ¬∑ Intensit√§t ${intensityVal || "?"}`;
      }

      header.appendChild(name);
      header.appendChild(handle);
      if (meta.textContent) header.appendChild(meta);

      body.appendChild(header);
      body.appendChild(textEl);

      tweet.appendChild(avatar);
      tweet.appendChild(body);

      repliesEl.appendChild(tweet);
      repliesEl.scrollTop = repliesEl.scrollHeight;

      replyCount++;
      toggleRepliesBtn.disabled = false;
      updateRepliesToggleLabel();
      if (!commentsVisible) {
        commentsVisible = true;
        repliesSectionEl.classList.remove("hidden");
      }
    }

    function updateRepliesToggleLabel() {
      const verb = commentsVisible ? "Kommentare ausblenden" : "Kommentare anzeigen";
      const chevronSpan = toggleRepliesBtn.querySelector(".chevron");
      if (chevronSpan) {
        chevronSpan.textContent = commentsVisible ? "‚ñ¥" : "‚ñæ";
        toggleRepliesBtn.lastChild.nodeValue = ` ${verb} (${replyCount})`;
      } else {
        toggleRepliesBtn.textContent = `${verb} (${replyCount})`;
      }
    }

    function toggleReplies() {
      if (toggleRepliesBtn.disabled) return;
      commentsVisible = !commentsVisible;
      if (commentsVisible) {
        repliesSectionEl.classList.remove("hidden");
      } else {
        repliesSectionEl.classList.add("hidden");
      }
      updateRepliesToggleLabel();
    }

    async function createThread() {
      const res = await fetch(`${BASE_URL}/threads`, {
        method: "POST",
        headers: buildHeaders(),
        body: "{}",
      });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`Thread-Erstellung fehlgeschlagen: ${res.status} ‚Äì ${txt}`);
      }
      const data = await res.json();
      return data.thread_id || data.id;
    }

    async function runWait(body) {
      if (!threadId) {
        threadId = await createThread();
      }

      const res = await fetch(`${BASE_URL}/threads/${threadId}/runs/wait`, {
        method: "POST",
        headers: buildHeaders(),
        body: JSON.stringify(Object.assign({ assistant_id: ASSISTANT_ID }, body)),
      });

      let data;
      try {
        data = await res.json();
      } catch (e) {
        const txt = await res.text();
        throw new Error("Antwort keine g√ºltige JSON: " + txt);
      }

      debugOutputEl.textContent = JSON.stringify(data, null, 2);

      if (!res.ok || data.__error__) {
        const errMsg =
          (data.__error__ && (data.__error__.message || data.__error__.error)) ||
          res.statusText;
        throw new Error("Server-Fehler: " + errMsg);
      }

      return data;
    }

    // ---- State-Finder: sucht rekursiv nach deinem Shitstorm-State ----
    function findState(obj, depth = 0) {
      if (!obj || typeof obj !== "object" || depth > 5) return null;

      const hasStateShape =
        Object.prototype.hasOwnProperty.call(obj, "last_community_comments") ||
        (Object.prototype.hasOwnProperty.call(obj, "platform") &&
          Object.prototype.hasOwnProperty.call(obj, "cause") &&
          Object.prototype.hasOwnProperty.call(obj, "intensity"));

      if (hasStateShape) {
        return obj;
      }

      for (const key of Object.keys(obj)) {
        const child = obj[key];
        if (child && typeof child === "object") {
          const found = findState(child, depth + 1);
          if (found) return found;
        }
      }

      return null;
    }

    function handleResult(result) {
      let interruptValue = null;
      if (Array.isArray(result.__interrupt__) && result.__interrupt__.length) {
        interruptValue = result.__interrupt__[0].value;
      }

      const state = findState(result) || {};

      if (typeof state.round === "number") {
        roundTextEl.textContent = String(state.round);
      }
      if (typeof state.intensity === "number") {
        intensityTextEl.textContent = state.intensity.toFixed(1) + " / 100";
      }

      if (state.cause) {
        causeGlobal = state.cause;
        scenarioShortEl.textContent = `Thema: ${causeGlobal}`;
      }

      const company = companyNameGlobal;

      if (state.last_company_response && state.last_company_response.trim()) {
        renderMainTweet(company, state.last_company_response, {
          round: state.round,
          intensity: state.intensity,
          cause: state.cause,
        });
      }

      if (Array.isArray(state.last_community_comments) && state.last_community_comments.length) {
        state.last_community_comments.forEach((c) =>
          appendReply("community", String(c), {
            round: state.round,
            intensity: state.intensity,
          })
        );
      }

      if (Array.isArray(state.history) && state.history.length) {
        const coachEntries = state.history.filter((h) => h.actor === "coach");
        if (coachEntries.length) {
          const last = coachEntries[coachEntries.length - 1];
          appendReply("coach", last.content || "", {
            round: last.round,
            intensity: state.intensity,
          });
        }
      }

      if (state.status && state.status !== "running") {
        finished = true;
        setComposerEnabled(false);
        let msg;
        if (state.status === "user_won") {
          msg = "Der Shitstorm ist weitgehend abgeklungen.";
        } else if (state.status === "user_lost") {
          msg = "Der Shitstorm ist au√üer Kontrolle geraten.";
        } else {
          msg = "Die Simulation wurde beendet.";
        }
        appendReply("system", msg, { round: state.round, intensity: state.intensity });
        if (state.summary) {
          appendReply("coach", state.summary, { round: state.round, intensity: state.intensity });
        }
        setStatus("beendet");
        return;
      }

      if (interruptValue) {
        waitingForAnswer = true;
        setComposerEnabled(true);
        setStatus("deine Antwort ist gefragt");
        answerInputEl.focus();
      } else {
        waitingForAnswer = false;
        setComposerEnabled(false);
        setStatus("l√§uft ‚Ä¶");
      }
    }

    async function startSimulation() {
      if (startedOnce) {
        resetThread();
      }
      startedOnce = true;
      setStatus("startet ‚Ä¶");

      const initialState = {
        platform: "X/Twitter",
        cause: causeGlobal,
        company_name: companyNameGlobal,
        round: 0,
        history: [],
        last_company_response: "",
        last_community_comments: [],
        politeness_score: 0.0,
        responsibility_score: 0.0,
        reaction_score: 0.0,
        intensity: 70.0,
        status: "running",
        summary: "",
      };

      try {
        const result = await runWait({ input: initialState });
        handleResult(result);
      } catch (err) {
        appendReply("system", "Fehler beim Starten der Simulation: " + err.message, {
          round: 0,
          intensity: 70,
        });
        setStatus("Fehler");
      }
    }

    async function sendAnswer() {
      if (!waitingForAnswer || finished) return;
      const answer = answerInputEl.value.trim();
      if (!answer) return;

      renderMainTweet(companyNameGlobal, answer, {
        cause: causeGlobal,
      });

      answerInputEl.value = "";
      setComposerEnabled(false);
      waitingForAnswer = false;
      setStatus("l√§uft ‚Ä¶");

      try {
        const result = await runWait({ command: { resume: answer } });
        handleResult(result);
      } catch (err) {
        appendReply("system", "Fehler beim Fortsetzen der Simulation: " + err.message);
        setStatus("Fehler");
        setComposerEnabled(false);
      }
    }

    // ===================== EVENTS =================================
    toggleRepliesBtn.addEventListener("click", toggleReplies);

    sendBtn.addEventListener("click", (ev) => {
      ev.preventDefault();
      sendAnswer();
    });

    answerInputEl.addEventListener("keydown", (ev) => {
      if ((ev.metaKey || ev.ctrlKey) && ev.key === "Enter") {
        ev.preventDefault();
        sendAnswer();
      }
    });

    // === Parameter aus index.html √ºbernehmen & auto-starten ===
    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const companyParam = params.get("company");
      const causeParam = params.get("cause");
      const auto = params.get("auto");

      if (companyParam) {
        companyNameGlobal = companyParam;
      }
      if (causeParam) {
        causeGlobal = causeParam;
      }

      resetThread();

      if (auto === "1") {
        setTimeout(() => {
          startSimulation();
        }, 0);
      } else {
        setComposerEnabled(true);
        setStatus("bereit");
      }
    });
  </script>
</body>
</html>
