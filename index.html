<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Shitstorm-Simulation Â· LangGraph</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #020617;
      --border-subtle: #1f2937;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;

      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);

      --platform-color: #1877f2;
      --platform-soft: rgba(24, 119, 242, 0.16);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      padding: 1.25rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background:
        radial-gradient(circle at top left, #1d283a 0, transparent 50%),
        radial-gradient(circle at bottom right, #020617 0, #000 60%);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    @media (min-width: 1024px) {
      body {
        padding: 1.5rem 2rem;
      }
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
      grid-template-rows: auto auto minmax(0, 1fr) auto;
      grid-template-areas:
        "header header"
        "settings settings"
        "chat chat"
        "debug debug";
      gap: 0.75rem;
    }

    @media (min-width: 1024px) {
      .layout {
        grid-template-areas:
          "header header"
          "settings chat"
          ". chat"
          "debug debug";
        grid-template-columns: minmax(280px, 360px) minmax(0, 1fr);
        grid-template-rows: auto auto minmax(0, 1fr) auto;
      }
    }

    .card {
      background: var(--bg-elevated);
      border-radius: 0.9rem;
      border: 1px solid var(--border-subtle);
      padding: 0.9rem 1.1rem;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(18px);
    }

    .header-card {
      grid-area: header;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .header-top {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      justify-content: space-between;
      gap: 0.75rem;
    }

    h1 {
      margin: 0;
      font-size: 1.35rem;
      letter-spacing: 0.01em;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    h1 span.logo-emoji {
      font-size: 1.35rem;
    }

    .status-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      justify-content: space-between;
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      border-radius: 999px;
      padding: 0.15rem 0.7rem;
      border: 1px solid var(--border-subtle);
      font-size: 0.78rem;
      background: rgba(15, 23, 42, 0.9);
    }

    .chip strong {
      font-weight: 600;
      color: var(--text-main);
    }

    .chip-platform {
      border-color: var(--platform-color);
      background: var(--platform-soft);
    }

    .chip-platform span.emoji {
      font-size: 1rem;
    }

    .chip-status {
      border-color: var(--accent);
      background: var(--accent-soft);
    }

    .tagline {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .settings-card {
      grid-area: settings;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .settings-grid {
      display: grid;
      gap: 0.75rem;
    }

    @media (min-width: 768px) {
      .settings-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    label {
      font-size: 0.78rem;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    input,
    select,
    textarea {
      background: #020617;
      border-radius: 0.55rem;
      border: 1px solid #374151;
      padding: 0.4rem 0.55rem;
      font: inherit;
      color: var(--text-main);
      min-width: 0;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
    }

    textarea {
      resize: vertical;
      min-height: 70px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 0.55rem 1.0rem;
      font: inherit;
      cursor: pointer;
      background-image: linear-gradient(135deg, #22c55e, #0ea5e9);
      color: #020617;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      white-space: nowrap;
      box-shadow: 0 10px 18px rgba(0, 0, 0, 0.35);
      transition: transform 0.06s ease, box-shadow 0.06s ease, filter 0.06s ease;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      filter: brightness(1.02);
      box-shadow: 0 14px 28px rgba(0, 0, 0, 0.55);
    }

    button:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
    }

    .btn-start {
      align-self: flex-start;
      margin-top: 0.25rem;
    }

    .main-card {
      grid-area: chat;
      display: flex;
      flex-direction: column;
      min-height: 260px;
      gap: 0.6rem;
    }

    .main-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    #chat {
      flex: 1;
      min-height: 160px;
      max-height: 55vh;
      overflow-y: auto;
      padding-right: 0.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      scroll-behavior: smooth;
    }

    .msg {
      padding: 0.48rem 0.75rem;
      border-radius: 0.75rem;
      max-width: 78%;
      font-size: 0.86rem;
      line-height: 1.4;
      white-space: pre-wrap;
      position: relative;
    }

    .msg.system {
      align-self: center;
      background: rgba(15, 23, 42, 0.92);
      border: 1px dashed #4b5563;
      max-width: 100%;
      color: var(--text-muted);
    }

    .msg.community {
      align-self: flex-start;
      background: #111827;
      border-radius: 0.9rem 0.9rem 0.9rem 0.3rem;
      border: 1px solid #1f2937;
    }

    .msg.company {
      align-self: flex-end;
      background: var(--accent);
      border-radius: 0.9rem 0.9rem 0.3rem 0.9rem;
      color: #022c22;
    }

    .msg.coach {
      align-self: flex-start;
      background: #020617;
      border-radius: 0.9rem;
      border: 1px solid #4f46e5;
    }

    .avatar-dot {
      position: absolute;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      top: -9px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
    }

    .msg.community .avatar-dot {
      left: -9px;
      background: var(--platform-color);
    }

    .msg.company .avatar-dot {
      right: -9px;
      background: #16a34a;
      color: #ecfdf5;
    }

    .msg.coach .avatar-dot {
      left: -9px;
      background: #4f46e5;
      color: #e0e7ff;
    }

    #answerForm {
      border-top: 1px dashed #1f2937;
      margin-top: 0.4rem;
      padding-top: 0.4rem;
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
    }

    #answerForm.disabled {
      opacity: 0.4;
      pointer-events: none;
    }

    .debug-card {
      grid-area: debug;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    #debug {
      max-height: 200px;
      overflow-y: auto;
      background: #020617;
      border-radius: 0.55rem;
      padding: 0.55rem 0.75rem;
      border: 1px solid #1f2937;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.72rem;
    }

    #debug summary {
      cursor: pointer;
      color: var(--text-muted);
      margin-bottom: 0.2rem;
    }

    #debugContent {
      margin: 0;
      padding: 0.25rem 0 0;
      white-space: pre;
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Header -->
    <section class="card header-card">
      <div class="header-top">
        <h1>
          <span class="logo-emoji">ðŸ”¥</span>
          <span>Shitstorm-Simulation</span>
        </h1>
        <div class="chip chip-status">
          <span>Status:</span>
          <strong id="statusText">noch nicht gestartet</strong>
        </div>
      </div>
      <div class="status-row">
        <div class="chip chip-platform">
          <span class="emoji" id="platformEmoji">ðŸ“˜</span>
          <span id="platformLabel">Facebook</span>
        </div>
        <div class="tagline" id="platformTagline">
          Klassische Kommentarspalte mit langen Threads und Stammkund:innen.
        </div>
      </div>
    </section>

    <!-- Settings -->
    <section class="card settings-card">
      <div class="settings-grid">
        <label>
          LangGraph Server URL
          <input id="baseUrl" value="https://samurai-4052add29c79569e878dca6f88299760.eu.langgraph.app" />
        </label>
        <label>
          Assistant / Graph ID
          <input id="assistantId" value="6d8594ea-8b76-5f28-bdfc-948df3e6d711" />
        </label>
        <label>
          Plattform
          <select id="platform">
            <option>Facebook</option>
            <option>Instagram</option>
            <option>X/Twitter</option>
            <option>TikTok</option>
            <option>LinkedIn</option>
            <option>YouTube</option>
          </select>
        </label>
      </div>

      <div class="settings-grid" style="margin-top: 0.75rem;">
        <label>
          Unternehmen
          <input id="companyName" value="Dein Unternehmen" />
        </label>
        <label>
          Ursache des Shitstorms
          <input id="cause" value="Unangemessene Werbekampagne" />
        </label>
      </div>

      <button id="startBtn" type="button" class="btn-start">
        <span>Simulation starten</span> <span>â–¶</span>
      </button>
    </section>

    <!-- Chat & Antwort -->
    <section class="card main-card">
      <div class="main-header-row">
        <div class="chip-group">
          <div class="chip">
            <span>Runde</span>
            <strong id="roundChip">â€“</strong>
          </div>
          <div class="chip">
            <span>IntensitÃ¤t</span>
            <strong id="intensityChip">â€“</strong>
          </div>
        </div>
        <span id="hintText" style="font-size: 0.8rem;">
          Ziel: IntensitÃ¤t unter 10 bringen â€“ ab 90 ist der Shitstorm auÃŸer Kontrolle.
        </span>
      </div>

      <div id="chat"></div>

      <form id="answerForm">
        <label>
          Deine Antwort als Unternehmen
          <textarea
            id="answerInput"
            placeholder="Formuliere hier deine Ã¶ffentliche Reaktion auf die Kommentare â€¦"
          ></textarea>
        </label>
        <div class="main-header-row">
          <span style="font-size: 0.78rem; color: var(--text-muted);" id="answerTip">
            Tipp: Empathie zeigen, Verantwortung Ã¼bernehmen, konkrete Schritte anbieten.
          </span>
          <button type="submit">
            <span>Antwort senden &amp; nÃ¤chste Runde</span> <span>â†©</span>
          </button>
        </div>
      </form>
    </section>

    <!-- Debug -->
    <section class="card debug-card">
      <details id="debug">
        <summary>Debug-Infos vom LangGraph-Server</summary>
        <pre id="debugContent"></pre>
      </details>
    </section>
  </div>

  <script>
    // === API-Key (falls Cloud-Deployment mit Auth) ==========================
    // FÃ¼r lokale Nutzung mit `langgraph dev` meist leer lassen.
    const API_KEY = "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"; // z.B. "lsv2_..."

    // === Plattform-Themes: Farbe, Emoji, Tagline, Text-Hints =================
    const PLATFORM_THEMES = {
      "Facebook": {
        emoji: "ðŸ“˜",
        label: "Facebook",
        color: "#1877F2",
        soft: "rgba(24,119,242,0.16)",
        tagline: "Lange Kommentar-Threads, Stammkund:innen und Ã¶ffentliche Diskussion.",
        answerPlaceholder: "Formuliere ein lÃ¤ngeres Facebook-Statement, das Situation und MaÃŸnahmen erklÃ¤rt â€¦",
        answerTip:
          "Facebook: ausfÃ¼hrlich, transparent und wertschÃ¤tzend. Hol die Community inhaltlich ab."
      },
      "Instagram": {
        emoji: "ðŸ“¸",
        label: "Instagram",
        color: "#E1306C",
        soft: "rgba(225,48,108,0.18)",
        tagline: "Visuelles Format, kurze Captions, Kommentare unter Posts & Reels.",
        answerPlaceholder: "Beschreibe dein Statement fÃ¼r einen Instagram-Post inkl. Caption â€¦",
        answerTip:
          "Instagram: kurze, klare Botschaft â€“ Emotion und Haltung sind wichtiger als Details."
      },
      "X/Twitter": {
        emoji: "ðŸ¦",
        label: "X / Twitter",
        color: "#1DA1F2",
        soft: "rgba(29,161,242,0.18)",
        tagline: "Schnelles, zugespitztes Format, viele Re-Posts und Zitate.",
        answerPlaceholder:
          "Formuliere ein prÃ¤gnantes Statement im Stil eines Tweets (kurz, klar, ohne Floskeln) â€¦",
        answerTip:
          "X: kurz, prÃ¤zise, ohne PR-Sprech. Jede Formulierung kann zitiert werden â€“ Klarheit vor LÃ¤nge."
      },
      "TikTok": {
        emoji: "ðŸŽµ",
        label: "TikTok",
        color: "#22d3ee",
        soft: "rgba(34,211,238,0.2)",
        tagline: "Video-Statements, schnelle Reaktionen, viele Duette und Stitchs.",
        answerPlaceholder:
          "Beschreibe dein TikTok-Video-Statement (Kernaussage, Ton, Call-to-Action) und die Caption â€¦",
        answerTip:
          "TikTok: authentisch, persÃ¶nlich, direkt in die Kamera. Kein Corporate-Hochglanz â€“ lieber klar & menschlich."
      },
      "LinkedIn": {
        emoji: "ðŸ’¼",
        label: "LinkedIn",
        color: "#0A66C2",
        soft: "rgba(10,102,194,0.2)",
        tagline: "Business-Perspektive, Stakeholder, Mitarbeitende und Partner lesen mit.",
        answerPlaceholder:
          "Formuliere ein professionelles LinkedIn-Statement mit klarer VerantwortungsÃ¼bernahme â€¦",
        answerTip:
          "LinkedIn: sachlich, verantwortungsvoll, mit Fokus auf Stakeholder, Mitarbeitende und langfristige MaÃŸnahmen."
      },
      "YouTube": {
        emoji: "â–¶ï¸",
        label: "YouTube",
        color: "#ef4444",
        soft: "rgba(239,68,68,0.2)",
        tagline: "LÃ¤ngere Videos, Kommentare unter dem Video, Creator-Rolle im Fokus.",
        answerPlaceholder:
          "Beschreibe dein YouTube-Video-Statement (Struktur, Kernaussage, evtl. angepinnter Kommentar) â€¦",
        answerTip:
          "YouTube: erklÃ¤re HintergrÃ¼nde und MaÃŸnahmen strukturiert, mit klarem Anfang, Mitte und Schluss."
      }
    };

    // === DOM-Referenzen =====================================================
    const chatEl = document.getElementById("chat");
    const statusTextEl = document.getElementById("statusText");
    const debugContentEl = document.getElementById("debugContent");
    const answerFormEl = document.getElementById("answerForm");
    const answerInputEl = document.getElementById("answerInput");
    const startBtn = document.getElementById("startBtn");
    const baseUrlInput = document.getElementById("baseUrl");
    const assistantIdInput = document.getElementById("assistantId");
    const platformSelect = document.getElementById("platform");
    const companyInput = document.getElementById("companyName");
    const causeInput = document.getElementById("cause");
    const platformEmojiEl = document.getElementById("platformEmoji");
    const platformLabelEl = document.getElementById("platformLabel");
    const platformTaglineEl = document.getElementById("platformTagline");
    const hintTextEl = document.getElementById("hintText");
    const answerTipEl = document.getElementById("answerTip");
    const roundChipEl = document.getElementById("roundChip");
    const intensityChipEl = document.getElementById("intensityChip");

    // === State ==============================================================
    let threadId = null;
    let waitingForAnswer = false;
    let finished = false;

    // === UI Helpers =========================================================
    function setStatus(text) {
      statusTextEl.textContent = text;
    }

    function appendMessage(role, text, platformEmoji = "") {
      const div = document.createElement("div");
      div.classList.add("msg");

      if (role === "community") div.classList.add("community");
      else if (role === "company") div.classList.add("company");
      else if (role === "coach") div.classList.add("coach");
      else div.classList.add("system");

      const avatar = document.createElement("div");
      avatar.classList.add("avatar-dot");
      if (role === "community") {
        avatar.textContent = platformEmoji || "ðŸ‘¥";
      } else if (role === "company") {
        avatar.textContent = "ðŸ¢";
      } else if (role === "coach") {
        avatar.textContent = "ðŸ§ ";
      } else {
        avatar.textContent = "â„¹";
      }
      div.appendChild(avatar);

      const prefix =
        role === "community"
          ? "Community: "
          : role === "company"
          ? "Unternehmen: "
          : role === "coach"
          ? "Coach: "
          : "";

      const textNode = document.createTextNode(prefix + text);
      div.appendChild(textNode);

      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function setAnswerFormEnabled(enabled) {
      if (enabled) {
        answerFormEl.classList.remove("disabled");
        answerInputEl.disabled = false;
      } else {
        answerFormEl.classList.add("disabled");
        answerInputEl.disabled = true;
      }
    }

    function showDebug(data) {
      debugContentEl.textContent = JSON.stringify(data, null, 2);
    }

    function applyPlatformTheme(platformName) {
      const cfg = PLATFORM_THEMES[platformName] || PLATFORM_THEMES["Facebook"];

      document.documentElement.style.setProperty("--platform-color", cfg.color);
      document.documentElement.style.setProperty("--platform-soft", cfg.soft);

      platformEmojiEl.textContent = cfg.emoji;
      platformLabelEl.textContent = cfg.label;
      platformTaglineEl.textContent = cfg.tagline;

      answerInputEl.placeholder = cfg.answerPlaceholder;
      answerTipEl.textContent = cfg.answerTip;
    }

    // === HTTP Helpers =======================================================
    function buildHeaders() {
      const headers = { "Content-Type": "application/json" };
      if (API_KEY && API_KEY.trim() !== "") {
        headers["x-api-key"] = API_KEY.trim();
      }
      return headers;
    }

    async function createThread(baseUrl) {
      const res = await fetch(baseUrl + "/threads", {
        method: "POST",
        headers: buildHeaders(),
        body: "{}"
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(
          "Thread-Erstellung fehlgeschlagen: " + res.status + " â€“ " + text
        );
      }
      const data = await res.json();
      // Offizielle API: { "thread_id": "..." }
      return data.thread_id || data.id;
    }

    async function runWait({ baseUrl, assistantId, input, command }) {
      if (!threadId) {
        threadId = await createThread(baseUrl);
      }

      const body = { assistant_id: assistantId };
      if (input !== null && input !== undefined) {
        body.input = input;
      }
      if (command !== null && command !== undefined) {
        body.command = command;
      }

      const res = await fetch(`${baseUrl}/threads/${threadId}/runs/wait`, {
        method: "POST",
        headers: buildHeaders(),
        body: JSON.stringify(body)
      });

      let data;
      try {
        data = await res.json();
      } catch (e) {
        const text = await res.text();
        throw new Error("Antwort keine gÃ¼ltige JSON: " + text);
      }

      showDebug(data);

      if (!res.ok || data.__error__) {
        const err =
          data && data.__error__
            ? data.__error__.message || data.__error__.error
            : res.statusText;
        throw new Error("Server-Fehler: " + err);
      }

      return data;
    }

    // === Shitstorm-spezifische Logik ========================================
    function updateMetaChips(state) {
      if (typeof state.round === "number") {
        roundChipEl.textContent = String(state.round);
      }
      if (typeof state.intensity === "number") {
        intensityChipEl.textContent = `${state.intensity.toFixed(1)} / 100`;
      }
    }

    function renderStateAfterCommunity(state) {
      updateMetaChips(state);
      const platformName = platformSelect.value;
      const cfg = PLATFORM_THEMES[platformName] || PLATFORM_THEMES["Facebook"];
      const emoji = cfg.emoji || "ðŸ‘¥";

      if (
        Array.isArray(state.last_community_comments) &&
        state.last_community_comments.length
      ) {
        appendMessage(
          "system",
          `Runde ${state.round} Â· IntensitÃ¤t: ${state.intensity.toFixed(
            1
          )} / 100`,
          emoji
        );
        appendMessage("system", "Die Community kommentiert:", emoji);
        state.last_community_comments.forEach((c) =>
          appendMessage("community", String(c), emoji)
        );
      }

      if (Array.isArray(state.history) && state.history.length) {
        const coachEntries = state.history.filter((h) => h.actor === "coach");
        if (coachEntries.length) {
          const last = coachEntries[coachEntries.length - 1];
          appendMessage("coach", last.content || "", "ðŸ§ ");
        }
      }
    }

    function renderFinalSummary(state) {
      finished = true;
      setAnswerFormEnabled(false);
      updateMetaChips(state);

      let outcomeText;
      if (state.status === "user_won") {
        outcomeText = "Der Shitstorm ist weitgehend abgeklungen.";
      } else if (state.status === "user_lost") {
        outcomeText = "Der Shitstorm ist auÃŸer Kontrolle geraten.";
      } else {
        outcomeText = "Die Simulation wurde beendet.";
      }

      appendMessage(
        "system",
        `Simulation beendet Â· EndgÃ¼ltige IntensitÃ¤t: ${state.intensity.toFixed(
          1
        )} / 100`
      );
      appendMessage("system", outcomeText);

      if (state.summary) {
        appendMessage("coach", state.summary, "ðŸ§ ");
      }
    }

    async function startSimulation() {
      const baseUrl = baseUrlInput.value.trim().replace(/\/+$/, "");
      const assistantId = assistantIdInput.value.trim();
      const platform = platformSelect.value;
      const cause =
        causeInput.value.trim() || "nicht nÃ¤her beschriebene Ursache";
      const companyName =
        companyInput.value.trim() || "Dein Unternehmen";

      if (!baseUrl || !assistantId) {
        alert("Bitte Server-URL und Assistant/Graph-ID ausfÃ¼llen.");
        return;
      }

      chatEl.innerHTML = "";
      debugContentEl.textContent = "";
      threadId = null;
      waitingForAnswer = false;
      finished = false;
      setAnswerFormEnabled(false);
      setStatus("Simulation wird gestartet â€¦");
      roundChipEl.textContent = "â€“";
      intensityChipEl.textContent = "â€“";

      appendMessage("system", `Plattform: ${platform}`);
      appendMessage("system", `Unternehmen: ${companyName}`);
      appendMessage("system", `Ursache des Shitstorms: ${cause}`);
      appendMessage(
        "system",
        "Ziel: IntensitÃ¤t durch gute Antworten unter 10 bringen â€“ ab 90 ist der Shitstorm auÃŸer Kontrolle."
      );

      const initialState = {
        platform: platform,
        cause: cause,
        company_name: companyName,
        round: 0,
        history: [],
        last_company_response: "",
        last_community_comments: [],
        politeness_score: 0.0,
        responsibility_score: 0.0,
        reaction_score: 0.0,
        intensity: 70.0,
        status: "running",
        summary: ""
      };

      try {
        const state = await runWait({
          baseUrl,
          assistantId,
          input: initialState,
          command: null
        });

        renderStateAfterCommunity(state);

        if (state.status && state.status !== "running") {
          setStatus("Simulation beendet");
          renderFinalSummary(state);
          return;
        }

        if (state.__interrupt__) {
          waitingForAnswer = true;
          setStatus("Deine Antwort ist gefragt");
          setAnswerFormEnabled(true);
          answerInputEl.focus();
        } else {
          waitingForAnswer = false;
          setAnswerFormEnabled(false);
          setStatus("Simulation beendet");
          renderFinalSummary(state);
        }
      } catch (err) {
        console.error(err);
        setStatus("Fehler beim Starten der Simulation");
        appendMessage(
          "system",
          "Fehler beim Starten der Simulation: " + err.message
        );
        setAnswerFormEnabled(false);
      }
    }

    async function sendCompanyAnswer(event) {
      event.preventDefault();
      if (!waitingForAnswer || finished) return;

      const baseUrl = baseUrlInput.value.trim().replace(/\/+$/, "");
      const assistantId = assistantIdInput.value.trim();
      const answer = answerInputEl.value.trim();

      if (!answer) return;

      appendMessage("company", answer, "ðŸ¢");
      answerInputEl.value = "";
      setAnswerFormEnabled(false);
      waitingForAnswer = false;
      setStatus("Simulation lÃ¤uft â€¦");

      try {
        const state = await runWait({
          baseUrl,
          assistantId,
          input: null,
          command: { resume: answer }
        });

        renderStateAfterCommunity(state);

        if (state.status && state.status !== "running") {
          setStatus("Simulation beendet");
          renderFinalSummary(state);
          return;
        }

        if (state.__interrupt__) {
          waitingForAnswer = true;
          setStatus("NÃ¤chste Antwort ist gefragt");
          setAnswerFormEnabled(true);
          answerInputEl.focus();
        } else {
          waitingForAnswer = false;
          setAnswerFormEnabled(false);
          setStatus("Simulation beendet");
          renderFinalSummary(state);
        }
      } catch (err) {
        console.error(err);
        appendMessage(
          "system",
          "Fehler beim Fortsetzen der Simulation: " + err.message
        );
        setStatus("Fehler");
        setAnswerFormEnabled(false);
      }
    }

    // === Event-Listener & Init =============================================
    startBtn.addEventListener("click", startSimulation);
    answerFormEl.addEventListener("submit", sendCompanyAnswer);
    platformSelect.addEventListener("change", (e) =>
      applyPlatformTheme(e.target.value)
    );

    // Initiales Theme setzen
    applyPlatformTheme(platformSelect.value);
  </script>
</body>
</html>
